<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#6B9080">
  <link rel="icon" type="image/svg+xml" href="assets/icons/favicon.svg">
  <link rel="apple-touch-icon" href="assets/icons/favicon.svg">
  <title>Recipe — BiteMe</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/recipe.css">
</head>
<body>
  <header>
    <nav class="recipe-nav">
      <a href="index.html" class="back-button" aria-label="Back to recipes">
        <svg data-icon="back" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></svg>
      </a>
      <h1 class="logo">bite<span class="logo-accent">me</span></h1>
      <a href="shopping.html" class="shopping-cart-link" aria-label="View shopping list">
        <svg data-icon="cart" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></svg>
        <span id="cart-count" class="cart-badge" style="display: none;">0</span>
      </a>
    </nav>
  </header>

  <main id="recipe-detail">
    <!-- Recipe will be loaded here by JavaScript -->
  </main>

  <script src="js/icons.js"></script>
    <script src="js/db.js"></script>
  <script src="js/recipes.js"></script>
  <script src="js/servings.js"></script>
  <script src="js/notes.js"></script>
  <script src="js/rating.js"></script>
  <script>
    // Load recipe detail
    document.addEventListener('DOMContentLoaded', async function() {
      const urlParams = new URLSearchParams(window.location.search);
      const recipeId = urlParams.get('id');

      if (!recipeId) {
        window.location.href = 'index.html';
        return;
      }

      const recipe = await getRecipeById(recipeId);

      if (!recipe) {
        document.getElementById('recipe-detail').innerHTML = `
          <div class="error">
            <p>Recipe not found.</p>
            <a href="index.html" class="button">Back to recipes</a>
          </div>
        `;
        return;
      }

      // Display recipe
      document.title = `${recipe.name} - biteme`;
      document.getElementById('recipe-detail').innerHTML = `
        <article class="recipe">
          <div class="recipe-header">
            <h2 class="recipe-name">${recipe.name}</h2>
            <div class="recipe-actions">
              <button id="share-btn" class="icon-button" aria-label="Share recipe">
                ${icon('share', 24)}
              </button>
              <button id="favorite-btn" class="icon-button favorite-button" aria-label="Add to favorites">
                ${icon('heart', 24)}
              </button>
            </div>
          </div>
          <p class="recipe-description">${recipe.description}</p>

          <div id="cooking-stats" class="cooking-stats"></div>

          <div class="recipe-tags">
            ${recipe.tags.map(tag => `<a href="index.html?tag=${encodeURIComponent(tag)}" class="tag tag-filter">${tag}</a>`).join('')}
          </div>

          <p class="recipe-meta">
            ${recipe.author ? `Recipe by ${recipe.author} \u00B7 ` : ''}${new Date(recipe.date + 'T00:00:00').toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' })}
          </p>

          <div id="cooking-notes-display"></div>

          <section class="ingredients">
            <h3>Ingredients</h3>
            <div class="serving-adjuster">
              <button id="decrease-servings" aria-label="Decrease servings">&minus;</button>
              <span><span id="current-servings">${recipe.servings}</span> servings</span>
              <button id="increase-servings" aria-label="Increase servings">+</button>
            </div>
            <div id="ingredients-list"></div>
          </section>

          <section class="instructions">
            <h3>Instructions</h3>
            <ol>
              ${recipe.steps.map((step, index) => {
                const parsedStep = parseStepText(step.text, recipe.ingredients, index);
                return `<li>${parsedStep}</li>`;
              }).join('')}
            </ol>
          </section>

          ${recipe.notes ? `
          <section class="recipe-notes">
            <h3>Notes</h3>
            ${recipe.notes.split('\n\n').map(p => `<p>${p}</p>`).join('')}
          </section>
          ` : ''}

          ${recipe.serving_suggestions ? `
          <section class="serving-suggestions">
            <h3>Serving Suggestions</h3>
            ${recipe.serving_suggestions.split('\n\n').map(p => `<p>${p}</p>`).join('')}
          </section>
          ` : ''}

          <div class="action-buttons">
            <button class="button button-primary" onclick="startCooking('${recipe.id}')">
              Start cooking
            </button>
          </div>
        </article>
      `;

      // Render ingredients with current serving ratio
      let currentServings = getServings(recipeId, recipe.servings);
      document.getElementById('current-servings').textContent = currentServings;
      renderIngredients(recipe, currentServings / recipe.servings);

      // Setup serving adjuster
      document.getElementById('decrease-servings').addEventListener('click', () => {
        if (currentServings > 1) {
          currentServings--;
          document.getElementById('current-servings').textContent = currentServings;
          setServings(recipeId, currentServings);
          renderIngredients(recipe, currentServings / recipe.servings);
          setupShoppingCartButtons(recipeId, recipe.name);
        }
      });
      document.getElementById('increase-servings').addEventListener('click', () => {
        currentServings++;
        document.getElementById('current-servings').textContent = currentServings;
        setServings(recipeId, currentServings);
        renderIngredients(recipe, currentServings / recipe.servings);
        setupShoppingCartButtons(recipeId, recipe.name);
      });

      // Setup favorite button
      setupFavoriteButton(recipeId);

      // Setup share button
      setupShareButton(recipe);

      // Setup add to cart buttons
      setupShoppingCartButtons(recipeId, recipe.name);

      // Show cooking stats + rating
      showCookingStats(recipeId);

      // Show cooking notes
      showCookingNotes(recipeId);

      // Update cart count
      updateCartCount();
    });

    function renderIngredients(recipe, ratio) {
      document.getElementById('ingredients-list').innerHTML = Object.entries(recipe.ingredients).map(([category, items]) => {
        if (items.length === 0) return '';
        return `
          <div class="ingredient-category">
            <h4>${category}</h4>
            <ul>
              ${items.map((ingredient) => {
                const displayText = scaleIngredientText(ingredient, ratio);
                return `
                <li>
                  <div class="ingredient-item">
                    <div class="ingredient-checkbox">
                      <input type="checkbox" id="ingredient-${ingredient.id}" />
                      <label for="ingredient-${ingredient.id}">${displayText}</label>
                    </div>
                    <button class="add-to-cart" data-ingredient-id="${ingredient.id}" aria-label="Add to shopping list">
                      ${icon('cart', 16)}
                    </button>
                  </div>
                </li>`;
              }).join('')}
            </ul>
          </div>
        `;
      }).join('');
    }

    async function setupFavoriteButton(recipeId) {
      await initDB();

      const favoriteBtn = document.getElementById('favorite-btn');
      const favorited = await isFavorited(recipeId);

      // Update button state
      updateFavoriteButton(favoriteBtn, favorited);

      // Handle click
      favoriteBtn.addEventListener('click', async () => {
        await toggleFavorite(recipeId);
        const newState = await isFavorited(recipeId);
        updateFavoriteButton(favoriteBtn, newState);
      });
    }

    function updateFavoriteButton(button, favorited) {
      if (favorited) {
        button.classList.add('favorited');
        button.setAttribute('aria-label', 'Remove from favorites');
      } else {
        button.classList.remove('favorited');
        button.setAttribute('aria-label', 'Add to favorites');
      }
    }

    function setupShareButton(recipe) {
      const shareBtn = document.getElementById('share-btn');

      shareBtn.addEventListener('click', async () => {
        const shareUrl = `${window.location.origin}/r/${recipe.id}.html`;
        const shareData = {
          title: `${recipe.name} — BiteMe`,
          text: recipe.description,
          url: shareUrl
        };

        if (navigator.share) {
          try {
            await navigator.share(shareData);
          } catch (err) {
            // User cancelled or share failed — ignore
          }
        } else {
          // Fallback: copy link to clipboard
          try {
            await navigator.clipboard.writeText(shareUrl);
            showCopyToast();
          } catch {
            // Clipboard API not available — do nothing
          }
        }
      });
    }

    function showCopyToast() {
      const existing = document.querySelector('.copy-toast');
      if (existing) existing.remove();

      const toast = document.createElement('div');
      toast.className = 'copy-toast';
      toast.textContent = 'Link copied!';
      document.body.appendChild(toast);
      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 2000);
    }

    function startCooking(id) {
      window.location.href = `cooking.html?id=${id}`;
    }

    async function setupShoppingCartButtons(recipeId, recipeName) {
      await initDB();

      const cartButtons = document.querySelectorAll('.add-to-cart');

      // Load current shopping list state for this recipe
      await updateCartButtonStates(recipeId);

      cartButtons.forEach(button => {
        button.addEventListener('click', async (e) => {
          e.preventDefault();
          const ingredientId = parseInt(button.getAttribute('data-ingredient-id'));
          const isAdded = button.classList.contains('in-cart');

          try {
            if (isAdded) {
              // Remove from list
              await removeFromShoppingList(recipeId, ingredientId);
              button.classList.remove('in-cart');
              button.setAttribute('aria-label', 'Add to shopping list');
            } else {
              // Add to list
              await addToShoppingList(recipeId, ingredientId);
              button.classList.add('in-cart');
              button.setAttribute('aria-label', 'Remove from shopping list');
            }

            // Update cart count with animation
            await updateCartCount();
          } catch (error) {
            console.error('Error updating shopping list:', error);
          }
        });
      });
    }

    async function updateCartButtonStates(recipeId) {
      const items = await getShoppingListByRecipe(recipeId);
      const cartButtons = document.querySelectorAll('.add-to-cart');

      cartButtons.forEach(button => {
        const ingredientId = parseInt(button.getAttribute('data-ingredient-id'));
        const inCart = items.some(item => item.ingredient_id === ingredientId);

        if (inCart) {
          button.classList.add('in-cart');
          button.setAttribute('aria-label', 'Remove from shopping list');
        } else {
          button.classList.remove('in-cart');
          button.setAttribute('aria-label', 'Add to shopping list');
        }
      });
    }

    async function showCookingStats(recipeId) {
      try {
        const sessions = await getCookingSessionsByRecipe(recipeId);
        if (sessions.length === 0) return;

        const durations = sessions.map(s => s.completed_at - s.started_at);
        const lastDuration = durations[durations.length - 1];

        const statsEl = document.getElementById('cooking-stats');
        if (!statsEl) return;

        const statsText = sessions.length === 1
          ? `Cooked once \u00B7 ${formatCookingDuration(lastDuration)}`
          : `Cooked ${sessions.length} times \u00B7 Last time: ${formatCookingDuration(lastDuration)}`;

        const existing = await getRating(recipeId);

        statsEl.textContent = '';
        statsEl.appendChild(document.createTextNode(statsText + (existing ? ' \u00B7 ' : ' ')));

        const stars = createStarRating(async (rating) => {
          await saveRating(recipeId, rating);
        }, existing ? existing.rating : 0);
        stars.classList.add('inline');
        statsEl.appendChild(stars);
      } catch {
        // Silently ignore
      }
    }

    async function updateCartCount() {
      const count = await getShoppingListCount();
      const badge = document.getElementById('cart-count');

      if (badge) {
        if (count > 0) {
          badge.textContent = count;
          badge.style.display = 'flex';
        } else {
          badge.style.display = 'none';
        }
      }
    }

    function escapeHtml(text) {
      return text.replace(/</g, '&lt;');
    }

    async function showCookingNotes(recipeId) {
      try {
        const note = await getCookingNote(recipeId);
        const container = document.getElementById('cooking-notes-display');
        if (!container) return;

        if (!note) {
          container.innerHTML = '';
          return;
        }

        container.innerHTML = `
          <section class="personal-notes">
            <div class="personal-notes-header">
              <h3>Personal Notes</h3>
              <button class="cooking-note-edit-btn" aria-label="Edit note">Edit</button>
            </div>
            <p class="cooking-note-text">${escapeHtml(note.text)}</p>
          </section>
        `;

        container.querySelector('.cooking-note-edit-btn').addEventListener('click', () => {
          enterNoteEditMode(recipeId, note.text);
        });
      } catch {
        // Silent fail
      }
    }

    function enterNoteEditMode(recipeId, text) {
      const container = document.getElementById('cooking-notes-display');
      if (!container) return;

      container.innerHTML = `
        <section class="personal-notes">
          <h3>Personal Notes</h3>
          <textarea class="cooking-note-textarea" rows="3">${escapeHtml(text)}</textarea>
          <div class="cooking-note-actions">
            <button class="cooking-note-save-btn">Save</button>
            <button class="cooking-note-cancel-btn">Cancel</button>
          </div>
        </section>
      `;

      const textarea = container.querySelector('.cooking-note-textarea');
      textarea.focus();

      container.querySelector('.cooking-note-save-btn').addEventListener('click', async () => {
        try {
          await saveCookingNote(recipeId, textarea.value);
          showCookingNotes(recipeId);
        } catch {
          // Silent fail
        }
      });

      container.querySelector('.cooking-note-cancel-btn').addEventListener('click', () => {
        showCookingNotes(recipeId);
      });
    }
  </script>
</body>
</html>
