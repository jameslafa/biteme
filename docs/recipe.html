<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Recipe details">
  <meta name="theme-color" content="#6B9080">
  <link rel="icon" type="image/svg+xml" href="assets/icons/favicon.svg">
  <link rel="apple-touch-icon" href="assets/icons/favicon.svg">
  <title>Recipe - biteme</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/recipe.css">
</head>
<body>
  <header>
    <nav class="recipe-nav">
      <a href="index.html" class="back-button" aria-label="Back to recipes">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
      </a>
      <h1 class="logo">bite<span class="logo-accent">me</span></h1>
      <a href="shopping.html" class="shopping-cart-link" aria-label="View shopping list">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="9" cy="21" r="1"/>
          <circle cx="20" cy="21" r="1"/>
          <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
        </svg>
        <span id="cart-count" class="cart-badge" style="display: none;">0</span>
      </a>
    </nav>
  </header>

  <main id="recipe-detail">
    <!-- Recipe will be loaded here by JavaScript -->
  </main>

  <script src="js/db.js"></script>
  <script src="js/recipes.js"></script>
  <script>
    // Load recipe detail
    document.addEventListener('DOMContentLoaded', async function() {
      const urlParams = new URLSearchParams(window.location.search);
      const recipeId = urlParams.get('id');

      if (!recipeId) {
        window.location.href = 'index.html';
        return;
      }

      const recipe = await getRecipeById(recipeId);

      if (!recipe) {
        document.getElementById('recipe-detail').innerHTML = `
          <div class="error">
            <p>Recipe not found.</p>
            <a href="index.html" class="button">Back to recipes</a>
          </div>
        `;
        return;
      }

      // Display recipe
      document.title = `${recipe.name} - biteme`;
      document.getElementById('recipe-detail').innerHTML = `
        <article class="recipe">
          <div class="recipe-header">
            <div>
              <h2 class="recipe-name">${recipe.name}</h2>
              <p class="recipe-description">${recipe.description}</p>
            </div>
            <button id="favorite-btn" class="favorite-button" aria-label="Add to favorites">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
              </svg>
            </button>
          </div>

          <div class="recipe-tags">
            ${recipe.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
          </div>

          <section class="ingredients">
            <h3>Ingredients</h3>
            ${Object.entries(recipe.ingredients).map(([category, items]) => {
              if (items.length === 0) return '';
              return `
                <div class="ingredient-category">
                  <h4>${category}</h4>
                  <ul>
                    ${items.map((ingredient) => `
                      <li>
                        <div class="ingredient-item">
                          <div class="ingredient-checkbox">
                            <input type="checkbox" id="ingredient-${ingredient.id}" />
                            <label for="ingredient-${ingredient.id}">${ingredient.text}</label>
                          </div>
                          <button class="add-to-cart" data-ingredient-id="${ingredient.id}" aria-label="Add to shopping list">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <circle cx="9" cy="21" r="1"/>
                              <circle cx="20" cy="21" r="1"/>
                              <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
                            </svg>
                          </button>
                        </div>
                      </li>
                    `).join('')}
                  </ul>
                </div>
              `;
            }).join('')}
          </section>

          <section class="instructions">
            <h3>Instructions</h3>
            <ol>
              ${recipe.steps.map((step, index) => {
                const parsedStep = parseStepText(step, recipe.ingredients, index);
                return `<li>${parsedStep}</li>`;
              }).join('')}
            </ol>
          </section>

          ${recipe.notes ? `
          <section class="recipe-notes">
            <h3>Notes</h3>
            <p>${recipe.notes}</p>
          </section>
          ` : ''}

          ${recipe.serving_suggestions ? `
          <section class="serving-suggestions">
            <h3>Serving Suggestions</h3>
            <p>${recipe.serving_suggestions}</p>
          </section>
          ` : ''}

          <div class="action-buttons">
            <button class="button button-primary" onclick="startCooking('${recipe.id}')">
              Start cooking
            </button>
          </div>
        </article>
      `;

      // Setup favorite button
      setupFavoriteButton(recipeId);

      // Setup add to cart buttons
      setupShoppingCartButtons(recipeId, recipe.name);

      // Update cart count
      updateCartCount();
    });

    async function setupFavoriteButton(recipeId) {
      await initDB();

      const favoriteBtn = document.getElementById('favorite-btn');
      const favorited = await isFavorited(recipeId);

      // Update button state
      updateFavoriteButton(favoriteBtn, favorited);

      // Handle click
      favoriteBtn.addEventListener('click', async () => {
        await toggleFavorite(recipeId);
        const newState = await isFavorited(recipeId);
        updateFavoriteButton(favoriteBtn, newState);
      });
    }

    function updateFavoriteButton(button, favorited) {
      if (favorited) {
        button.classList.add('favorited');
        button.setAttribute('aria-label', 'Remove from favorites');
      } else {
        button.classList.remove('favorited');
        button.setAttribute('aria-label', 'Add to favorites');
      }
    }

    function startCooking(id) {
      window.location.href = `cooking.html?id=${id}`;
    }

    async function setupShoppingCartButtons(recipeId, recipeName) {
      await initDB();

      const cartButtons = document.querySelectorAll('.add-to-cart');

      // Load current shopping list state for this recipe
      await updateCartButtonStates(recipeId);

      cartButtons.forEach(button => {
        button.addEventListener('click', async (e) => {
          e.preventDefault();
          const ingredientId = parseInt(button.getAttribute('data-ingredient-id'));
          const isAdded = button.classList.contains('in-cart');

          try {
            if (isAdded) {
              // Remove from list
              await removeFromShoppingList(recipeId, ingredientId);
              button.classList.remove('in-cart');
              button.setAttribute('aria-label', 'Add to shopping list');
            } else {
              // Add to list
              await addToShoppingList(recipeId, ingredientId);
              button.classList.add('in-cart');
              button.setAttribute('aria-label', 'Remove from shopping list');
            }

            // Update cart count with animation
            await updateCartCount();
          } catch (error) {
            console.error('Error updating shopping list:', error);
          }
        });
      });
    }

    async function updateCartButtonStates(recipeId) {
      const items = await getShoppingListByRecipe(recipeId);
      const cartButtons = document.querySelectorAll('.add-to-cart');

      cartButtons.forEach(button => {
        const ingredientId = parseInt(button.getAttribute('data-ingredient-id'));
        const inCart = items.some(item => item.ingredient_id === ingredientId);

        if (inCart) {
          button.classList.add('in-cart');
          button.setAttribute('aria-label', 'Remove from shopping list');
        } else {
          button.classList.remove('in-cart');
          button.setAttribute('aria-label', 'Add to shopping list');
        }
      });
    }

    async function updateCartCount() {
      const count = await getShoppingListCount();
      const badge = document.getElementById('cart-count');

      if (badge) {
        if (count > 0) {
          badge.textContent = count;
          badge.style.display = 'flex';
        } else {
          badge.style.display = 'none';
        }
      }
    }
  </script>
</body>
</html>
