<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Recipe details">
  <meta name="theme-color" content="#6B9080">
  <link rel="icon" type="image/svg+xml" href="assets/icons/favicon.svg">
  <link rel="apple-touch-icon" href="assets/icons/favicon.svg">
  <title>Recipe - biteme</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/recipe.css">
</head>
<body>
  <header>
    <nav class="recipe-nav">
      <a href="index.html" class="back-button" aria-label="Back to recipes">‚Üê Back</a>
      <h1>biteme</h1>
    </nav>
  </header>

  <main id="recipe-detail">
    <!-- Recipe will be loaded here by JavaScript -->
  </main>

  <script src="js/db.js"></script>
  <script src="js/recipes.js"></script>
  <script>
    // Load recipe detail
    document.addEventListener('DOMContentLoaded', function() {
      const urlParams = new URLSearchParams(window.location.search);
      const recipeId = urlParams.get('id');

      if (!recipeId) {
        window.location.href = 'index.html';
        return;
      }

      const recipe = getRecipeById(recipeId);

      if (!recipe) {
        document.getElementById('recipe-detail').innerHTML = `
          <div class="error">
            <p>Recipe not found.</p>
            <a href="index.html" class="button">Back to Recipes</a>
          </div>
        `;
        return;
      }

      // Display recipe
      document.title = `${recipe.name} - biteme`;
      document.getElementById('recipe-detail').innerHTML = `
        <article class="recipe">
          <div class="recipe-header">
            <div>
              <h2 class="recipe-name">${recipe.name}</h2>
              <p class="recipe-description">${recipe.description}</p>
            </div>
            <button id="favorite-btn" class="favorite-button" aria-label="Add to favorites">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
              </svg>
            </button>
          </div>

          <div class="recipe-tags">
            ${recipe.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
          </div>

          <section class="ingredients">
            <h3>Ingredients</h3>
            ${Object.entries(recipe.ingredients).map(([category, items]) => {
              if (items.length === 0) return '';
              return `
                <div class="ingredient-category">
                  <h4>${category}</h4>
                  <ul>
                    ${items.map((ingredient, index) => `
                      <li>
                        <input type="checkbox" id="ingredient-${category}-${index}" />
                        <label for="ingredient-${category}-${index}">${ingredient}</label>
                      </li>
                    `).join('')}
                  </ul>
                </div>
              `;
            }).join('')}
          </section>

          <section class="instructions">
            <h3>Instructions</h3>
            <ol>
              ${recipe.steps.map((step, index) => {
                const parsedStep = parseStepText(step, recipe.ingredients, index);
                return `<li>${parsedStep}</li>`;
              }).join('')}
            </ol>
          </section>

          <div class="action-buttons">
            <button class="button button-primary" onclick="startCooking(${recipe.id})">
              Start Cooking
            </button>
          </div>
        </article>
      `;

      // Setup favorite button
      setupFavoriteButton(recipeId);
    });

    async function setupFavoriteButton(recipeId) {
      await initDB();

      const favoriteBtn = document.getElementById('favorite-btn');
      const favorited = await isFavorited(recipeId);

      // Update button state
      updateFavoriteButton(favoriteBtn, favorited);

      // Handle click
      favoriteBtn.addEventListener('click', async () => {
        await toggleFavorite(recipeId);
        const newState = await isFavorited(recipeId);
        updateFavoriteButton(favoriteBtn, newState);
      });
    }

    function updateFavoriteButton(button, favorited) {
      if (favorited) {
        button.classList.add('favorited');
        button.setAttribute('aria-label', 'Remove from favorites');
      } else {
        button.classList.remove('favorited');
        button.setAttribute('aria-label', 'Add to favorites');
      }
    }

    function startCooking(id) {
      window.location.href = `cooking.html?id=${id}`;
    }
  </script>
</body>
</html>
